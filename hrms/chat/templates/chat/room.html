<!DOCTYPE html>
<html>
<head>
    <title>Chat Room: {{ room_name }}</title>
</head>
<body>
<h2>Room: {{ room_name }}</h2>
<div id="chat-log" style="height:300px; border:1px solid #ccc; overflow-y:scroll;">
    {% for msg in messages %}
        <p><b>{{ msg.user.username }}:</b> {{ msg.content }}
        {% if msg.image %}<br><img src="{{ msg.image.url }}" width="100">{% endif %}
        </p>
    {% endfor %}
</div>
<input id="chat-message-input" type="text" size="50">
<input type="file" id="chat-image-input">
<button id="chat-message-submit">Send</button>

<script>
const roomName = "{{ room_name }}";
const ws = new WebSocket(`ws://${window.location.host}/ws/chat/${roomName}/`);

ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const log = document.getElementById('chat-log');
    let msgHtml = `<p><b>${data.username}:</b> ${data.message}`;
    if(data.image) msgHtml += `<br><img src="${data.image}" width="100">`;
    msgHtml += `</p>`;
    log.innerHTML += msgHtml;
    log.scrollTop = log.scrollHeight;
};

document.getElementById('chat-message-submit').onclick = function() {
    const input = document.getElementById('chat-message-input');
    const fileInput = document.getElementById('chat-image-input');
    let image_url = null;

    if(fileInput.files.length > 0){
        const file = fileInput.files[0];
        image_url = URL.createObjectURL(file); // For demo only
    }

    ws.send(JSON.stringify({'message': input.value, 'username': 'You', 'image': image_url}));
    input.value = '';
    fileInput.value = '';
};
</script>
</body>
</html>
